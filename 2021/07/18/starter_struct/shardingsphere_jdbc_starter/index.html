<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"ceaser.wang","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.12.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Sharding-JDBC简介定位为轻量级Java框架，在Java的JDBC层提供的额外服务。 它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。  适用于任何基于JDBC的ORM框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template或直接使用JDBC。 支持任何第三方的">
<meta property="og:type" content="article">
<meta property="og:title" content="shardingsphere_jdbc_starter">
<meta property="og:url" content="https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/index.html">
<meta property="og:site_name" content="南贺神社">
<meta property="og:description" content="Sharding-JDBC简介定位为轻量级Java框架，在Java的JDBC层提供的额外服务。 它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。  适用于任何基于JDBC的ORM框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template或直接使用JDBC。 支持任何第三方的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://shardingsphere.apache.org/document/legacy/4.x/document/img/sharding-jdbc-brief.png">
<meta property="og:image" content="https://i.loli.net/2021/07/18/5bMpSuartDmW2L7.png">
<meta property="article:published_time" content="2021-07-18T22:01:45.000Z">
<meta property="article:modified_time" content="2022-12-31T09:34:23.216Z">
<meta property="article:author" content="CeaserWang">
<meta property="article:tag" content="shardingsphere">
<meta property="article:tag" content="jdbc">
<meta property="article:tag" content="starter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://shardingsphere.apache.org/document/legacy/4.x/document/img/sharding-jdbc-brief.png">


<link rel="canonical" href="https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/","path":"2021/07/18/starter_struct/shardingsphere_jdbc_starter/","title":"shardingsphere_jdbc_starter"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>shardingsphere_jdbc_starter | 南贺神社</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">南贺神社</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">你写程序有写诗一样的感觉吗?</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">207</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">25</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">215</span></a></li><li class="menu-item menu-item-0xcc"><a href="/0xcc/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>0XCC</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharding-JDBC%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">Sharding-JDBC简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharding-JDBC%E5%9C%A8%E4%BD%BF%E7%94%A8%E4%B8%8A%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">Sharding-JDBC在使用上的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#twodragonlake-sharding-jdbc-starter%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.</span> <span class="nav-text">twodragonlake-sharding-jdbc-starter设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%94%9F%E6%88%90datasource"><span class="nav-number">3.1.</span> <span class="nav-text">加载配置，生成datasource</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#DataSourceConfiger%E7%9A%84%E6%88%90%E5%91%98"><span class="nav-number">3.1.1.</span> <span class="nav-text">DataSourceConfiger的成员</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#EnvironmentAware"><span class="nav-number">3.1.2.</span> <span class="nav-text">EnvironmentAware</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%89%80%E6%9C%89%E7%9A%84%E5%AE%9E%E4%BD%93%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%8C%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">3.1.3.</span> <span class="nav-text">初始化所有的实体数据源，设置默认数据源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%89%80%E6%9C%89%E9%80%BB%E8%BE%91%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84shardingsphere%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8C%85%E6%8B%AC%E9%BB%98%E8%AE%A4%E9%80%BB%E8%BE%91%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.4.</span> <span class="nav-text">加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAShardingsphere%E9%80%BB%E8%BE%91%E6%95%B0%E6%8D%AE%E6%BA%90%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1%EF%BC%8C%E9%85%8D%E7%BD%AE%E4%BA%8B%E7%89%A9%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">4.</span> <span class="nav-text">创建Shardingsphere逻辑数据源实例对象，配置事物管理器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">4.1.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MybatisConfigure%E5%AE%9E%E4%BE%8B%E5%8C%96mybatis%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">MybatisConfigure实例化mybatis的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MapperScannerConfigurer%E5%88%87%E6%8D%A2mapper%E7%9A%84sqlTemplate%E4%B8%BA%E5%AE%9E%E9%99%85%E9%9C%80%E8%A6%81%E7%9A%84sqlTemplate"><span class="nav-number">5.1.</span> <span class="nav-text">MapperScannerConfigurer切换mapper的sqlTemplate为实际需要的sqlTemplate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">5.2.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Encryptor%E5%AE%9E%E7%8E%B0%E5%AE%9A%E5%88%B6%E5%8C%96%E8%84%B1%E6%95%8F%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-number">6.</span> <span class="nav-text">使用Encryptor实现定制化脱敏编解码器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0Encryptor%E6%8E%A5%E5%8F%A3%E5%AE%9A%E5%88%B6%E4%B8%80%E4%B8%AA%E8%84%B1%E6%95%8F%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-number">6.1.</span> <span class="nav-text">实现Encryptor接口定制一个脱敏编解码器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BDEncryptor"><span class="nav-number">7.</span> <span class="nav-text">加载Encryptor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%AF%BC"><span class="nav-number">7.1.</span> <span class="nav-text">引导</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-number">7.2.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CeaserWang"
      src="/../0xcc/index/Uchiha.jpg">
  <p class="site-author-name" itemprop="name">CeaserWang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">215</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">207</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzExNTY3MjE4NzQ=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1156721874"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmNlYXNlcndhbmdAb3V0bG9vay5jb20=" title="E-Mail → mailto:ceaserwang@outlook.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-user-friends fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly90d29kcmFnb25sYWtlLmNvbQ==" title="https:&#x2F;&#x2F;twodragonlake.com">TwoDragonLake</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9yb290Y2x1c3Rlci5naXRodWIuaW8=" title="https:&#x2F;&#x2F;rootcluster.github.io">RootCluster</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9tdXNlZmxvdy5pbw==" title="https:&#x2F;&#x2F;museflow.io">MuseFlow</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9pbmNvZGVyLm9yZw==" title="https:&#x2F;&#x2F;incoder.org">BladeCode</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9rYWlmYS5kZXY=" title="https:&#x2F;&#x2F;kaifa.dev">Alyenc</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmRhemhpZGF5b25nLmNu" title="https:&#x2F;&#x2F;blog.dazhidayong.cn">Killua</span>
        </li>
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly9qb2NlbHluc2hhbmcuY24v" title="https:&#x2F;&#x2F;jocelynshang.cn&#x2F;">Jocelyn</span>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/../0xcc/index/Uchiha.jpg">
      <meta itemprop="name" content="CeaserWang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="南贺神社">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="shardingsphere_jdbc_starter | 南贺神社">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          shardingsphere_jdbc_starter
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-18 22:01:45" itemprop="dateCreated datePublished" datetime="2021-07-18T22:01:45+00:00">2021-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-31 09:34:23" itemprop="dateModified" datetime="2022-12-31T09:34:23+00:00">2022-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/starter-struct/" itemprop="url" rel="index"><span itemprop="name">starter_struct</span></a>
        </span>
    </span>

  
    <span id="/2021/07/18/starter_struct/shardingsphere_jdbc_starter/" class="post-meta-item leancloud_visitors" data-flag-title="shardingsphere_jdbc_starter" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="Sharding-JDBC简介"><a href="#Sharding-JDBC简介" class="headerlink" title="Sharding-JDBC简介"></a>Sharding-JDBC简介</h3><p>定位为轻量级Java框架，在Java的JDBC层提供的额外服务。 它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。</p>
<ul>
<li>适用于任何基于JDBC的ORM框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template或直接使用JDBC。</li>
<li>支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP等。<br> 支持任意实现JDBC规范的数据库。目前支持MySQL，Oracle，SQLServer，PostgreSQL以及任何遵循SQL92标准的数据库。</li>
</ul>
<p> <img src="https://shardingsphere.apache.org/document/legacy/4.x/document/img/sharding-jdbc-brief.png" alt="image.png"></p>
<span id="more"></span>
<p>官方提供了数据分片、读写分离、数据脱敏的三种配置:<br><span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2xlZ2FjeS80LngvZG9jdW1lbnQvY24vbWFudWFsL3NoYXJkaW5nLWpkYmMvY29uZmlndXJhdGlvbi9jb25maWctc3ByaW5nLWJvb3Qv">SPRING BOOT配置<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="Sharding-JDBC在使用上的问题"><a href="#Sharding-JDBC在使用上的问题" class="headerlink" title="Sharding-JDBC在使用上的问题"></a>Sharding-JDBC在使用上的问题</h3><p>Sharding-JDBC 在启动的时候需要加载分片、脱敏、读写分离等这些配置，加载时候只认识以spring.shardingsphere开头的配置信息，并且不支持加载多次，什么意思呢，加入我的app使用了2套数据库系统，订单系统使用了oracle，商品系统使用了mysql，但是他们的代码逻辑存在耦合，放在一个app里边，在一个jvm里边启动app，同时呢，订单和商品都是分库分表的，并且订单数据有些字段需要加密，这就使用到了Sharding-jdbc的数据分片，数据脱敏，而且分别应用到2套数据库分片系统，需要加载好多datasource，一个逻辑库，对应n个实体库，每个实体库都是一个datasource对象，如果使用Sharding-jdbc原来的加载机制，是无法完成这个工作的，因为shardingsphere对的配置都是spring.shardingsphere开头的，但是我的多个不同的逻辑数据库使用了不同的分片策略，需要另外一套spring.shardingsphere前缀开头的配置，因此需要进行一次Sharding-jdbc的封装，做一个springboot的starter。</p>
<h3 id="twodragonlake-sharding-jdbc-starter设计"><a href="#twodragonlake-sharding-jdbc-starter设计" class="headerlink" title="twodragonlake-sharding-jdbc-starter设计"></a>twodragonlake-sharding-jdbc-starter设计</h3><p>假如我们有一个逻辑数据库：cs，然后分了三个实体数据库cs1、cs2、cs3.<br>然后有一个ds逻辑数据库，他有三个实体数据库:ds1、ds2、ds3.<br>然后我们还设置了一个默认实体数据库cs1.<br>我们先用我们自己的定义规范定义这些数据库:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">#默认实体数据库cs1</span><br><span class="line">jdbc.datasource.defaultDS=ds</span><br><span class="line"></span><br><span class="line"># 独立的一个数据源</span><br><span class="line">jdbc.datasource.tnp_product.url = jdbc:mysql://192.168.120.17:3306/tnp_product?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.tnp_product.username = tnp_dev</span><br><span class="line">jdbc.datasource.tnp_product.password = tnp_dev</span><br><span class="line">jdbc.datasource.tnp_product.pool = druid</span><br><span class="line">jdbc.datasource.tnp_product.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line">jdbc.datasource.ds.names = ds1,ds2,ds3</span><br><span class="line"></span><br><span class="line"># ds1的数据源配置</span><br><span class="line">jdbc.datasource.ds.ds1.url = jdbc:mysql://192.168.120.17:3306/ds1?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.ds.ds1.username = ds1</span><br><span class="line">jdbc.datasource.ds.ds1.password = ds1</span><br><span class="line">jdbc.datasource.ds.ds1.pool = druid</span><br><span class="line">jdbc.datasource.ds.ds1.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line"># ds2的数据源配置</span><br><span class="line">jdbc.datasource.ds.ds2.url = jdbc:mysql://192.168.120.17:3306/ds2?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.ds.ds2.username = tnp_dev</span><br><span class="line">jdbc.datasource.ds.ds2.password = tnp_dev</span><br><span class="line">jdbc.datasource.ds.ds2.pool = druid</span><br><span class="line">jdbc.datasource.ds.ds2.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line"># ds3的数据源配置</span><br><span class="line">jdbc.datasource.ds.ds3.url = jdbc:mysql://192.168.120.17:3306/ds3?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.ds.ds3.username = tnp_dev</span><br><span class="line">jdbc.datasource.ds.ds3.password = tnp_dev</span><br><span class="line">jdbc.datasource.ds.ds3.pool = druid</span><br><span class="line">jdbc.datasource.ds.ds3.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line">#对ds逻辑数据库进行分片+数据脱敏配置，没有ds前缀意味着ds是一个默认数据源</span><br><span class="line">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column = user_id</span><br><span class="line">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression = ds$-&gt;&#123;user_id % 3 + 3&#125;</span><br><span class="line">spring.shardingsphere.sharding.binding-tables = health_record,health_task</span><br><span class="line">spring.shardingsphere.sharding.broadcast-tables = health_level</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.actual-data-nodes = ds$-&gt;&#123;1..3&#125;.health_record$-&gt;&#123;0..2&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.table-strategy.inline.sharding-column = record_id</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.table-strategy.inline.algorithm-expression = health_record$-&gt;&#123;record_id % 3&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.key-generator.column = record_id</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.key-generator.type = SNOWFLAKE</span><br><span class="line">spring.shardingsphere.sharding.tables.health_record.key-generator.props.worker.id = 33</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.actual-data-nodes = ds$-&gt;&#123;1..3&#125;.health_task$-&gt;&#123;0..2&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.table-strategy.inline.sharding-column = record_id</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.table-strategy.inline.algorithm-expression = health_task$-&gt;&#123;record_id % 3&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.key-generator.column = task_id</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.key-generator.type = SNOWFLAKE</span><br><span class="line">spring.shardingsphere.sharding.tables.health_task.key-generator.props.worker.id = 33</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.actual-data-nodes = ds$-&gt;&#123;1..3&#125;.encrypt_user$-&gt;&#123;0..2&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.table-strategy.inline.sharding-column = user_id</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.table-strategy.inline.algorithm-expression = encrypt_user$-&gt;&#123;user_id % 3&#125;</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.key-generator.column = user_id</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.key-generator.type = SNOWFLAKE</span><br><span class="line">spring.shardingsphere.sharding.tables.encrypt_user.key-generator.props.worker.id = 33</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.encryptors.encryptor_aes.type = LLPayAES</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.encryptors.encryptor_aes.props.aes.key.value = 123456</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.plain-column = user_name_plain</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.cipher-column = user_name</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.encryptor = encryptor_aes</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.pwd.cipher-column = pwd</span><br><span class="line">spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.pwd.encryptor = encryptor_aes</span><br><span class="line">spring.shardingsphere.sharding.props.sql.show = true</span><br><span class="line"></span><br><span class="line">#cs逻辑数据库有三个实体数据库分片</span><br><span class="line">jdbc.datasource.cs.names = cs1,cs2,cs3</span><br><span class="line"></span><br><span class="line"># cs1的数据源配置</span><br><span class="line">jdbc.datasource.cs.cs1.url = jdbc:mysql://192.168.120.17:3306/cs1?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.cs.cs1.username = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs1.password = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs1.pool = druid</span><br><span class="line">jdbc.datasource.cs.cs1.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line"># cs2的数据源配置</span><br><span class="line">jdbc.datasource.cs.cs2.url = jdbc:mysql://192.168.120.17:3306/cs2?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.cs.cs2.username = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs2.password = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs2.pool = druid</span><br><span class="line">jdbc.datasource.cs.cs2.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line"># cs3的数据源配置</span><br><span class="line">jdbc.datasource.cs.cs3.url = jdbc:mysql://192.168.120.17:3306/cs3?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">jdbc.datasource.cs.cs3.username = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs3.password = tnp_dev</span><br><span class="line">jdbc.datasource.cs.cs3.pool = druid</span><br><span class="line">jdbc.datasource.cs.cs3.driverClass = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line">#对cs逻辑数据库进行分片+数据脱敏配置</span><br><span class="line">cs.spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column = user_id</span><br><span class="line">cs.spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression = cs$-&gt;&#123;user_id % 3 + 3&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.binding-tables = health_record,health_task</span><br><span class="line">cs.spring.shardingsphere.sharding.broadcast-tables = health_level</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.actual-data-nodes = cs$-&gt;&#123;1..3&#125;.health_record$-&gt;&#123;0..2&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.table-strategy.inline.sharding-column = record_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.table-strategy.inline.algorithm-expression = health_record$-&gt;&#123;record_id % 3&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.key-generator.column = record_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.key-generator.type = SNOWFLAKE</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_record.key-generator.props.worker.id = 33</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.actual-data-nodes = cs$-&gt;&#123;1..3&#125;.health_task$-&gt;&#123;0..2&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.table-strategy.inline.sharding-column = record_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.table-strategy.inline.algorithm-expression = health_task$-&gt;&#123;record_id % 3&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.key-generator.column = task_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.key-generator.type = SNOWFLAKE</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.health_task.key-generator.props.worker.id = 33</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.actual-data-nodes = cs$-&gt;&#123;1..3&#125;.encrypt_user$-&gt;&#123;0..2&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.table-strategy.inline.sharding-column = user_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.table-strategy.inline.algorithm-expression = encrypt_user$-&gt;&#123;user_id % 3&#125;</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.key-generator.column = user_id</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.key-generator.type = SNOWFLAKE</span><br><span class="line">cs.spring.shardingsphere.sharding.tables.encrypt_user.key-generator.props.worker.id = 33</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.encryptors.encryptor_aes.type = LLPayAES</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.encryptors.encryptor_aes.props.aes.key.value = 123456</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.plain-column = user_name_plain</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.cipher-column = user_name</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.user_name.encryptor = encryptor_aes</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.pwd.cipher-column = pwd</span><br><span class="line">cs.spring.shardingsphere.sharding.encrypt-rule.tables.encrypt_user.columns.pwd.encryptor = encryptor_aes</span><br><span class="line">cs.spring.shardingsphere.sharding.props.sql.show = true</span><br></pre></td></tr></table></figure>

<h4 id="加载配置，生成datasource"><a href="#加载配置，生成datasource" class="headerlink" title="加载配置，生成datasource"></a>加载配置，生成datasource</h4><p>我们定义DataSourceConfiger类，是一个数据源配置管理器，它实现了EnvironmentAware、BeanFactoryPostProcessor。</p>
<h5 id="DataSourceConfiger的成员"><a href="#DataSourceConfiger的成员" class="headerlink" title="DataSourceConfiger的成员"></a>DataSourceConfiger的成员</h5><ul>
<li>PropertiesReader、Environment，PropertiesReader用来读取Environment当中的配置。</li>
<li>String defaultLogicDsName：默认的逻辑数据源，这里是ds。</li>
<li>Map&lt;String, Map&lt;String, DataSource&gt;&gt; originalDataSourceMaps：<ul>
<li>key:logicDsName;value:{key:realDsName,value:DataSource}，即一个逻辑数据源对应多个真实的实体数据源。</li>
</ul>
</li>
<li>Map&lt;String,ShardingspherePropertiesConfig&gt; logicDsNameToshardingspherePropertiesConfigs：<ul>
<li>shardingsphere的逻辑数据源和数据源配置的映射。</li>
</ul>
</li>
</ul>
<h5 id="EnvironmentAware"><a href="#EnvironmentAware" class="headerlink" title="EnvironmentAware"></a>EnvironmentAware</h5><p>EnvironmentAware的作用主要是用来配置DataSourceConfiger的环境，为DataSourceConfiger提供配置环境管理的能力，DataSourceConfiger需要实现EnvironmentAware的setEnvironment<br>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setEnvironment(Environment environment) &#123;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">    this.propertiesReader = new PropertiesReader() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public String getString(String propertyName) &#123;</span><br><span class="line">            return environment.getProperty(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    // 初始化所有的实体数据源，设置默认数据源</span><br><span class="line">    initDataSourceMap(environment);</span><br><span class="line">    //加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置</span><br><span class="line">    initPropertiesAndDataSource(environment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="初始化所有的实体数据源，设置默认数据源"><a href="#初始化所有的实体数据源，设置默认数据源" class="headerlink" title="初始化所有的实体数据源，设置默认数据源"></a>初始化所有的实体数据源，设置默认数据源</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private void initDataSourceMap(Environment environment) throws Throwable &#123;</span><br><span class="line">    StandardEnvironment standardEnv = (StandardEnvironment) environment;</span><br><span class="line">    defaultLogicDsName = standardEnv.getProperty(&quot;jdbc.datasource.defaultDS&quot;);</span><br><span class="line">    // 默认数据源没有配置启动异常</span><br><span class="line">    if(StringUtils.isBlank(defaultLogicDsName))&#123;</span><br><span class="line">        logger.error(&quot;you should point jdbc.datasource.defaultDS key.&quot;);</span><br><span class="line">        throw new Throwable(&quot;you should point jdbc.datasource.defaultDS key.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //实例化所有逻辑数据源的实体数据源</span><br><span class="line">    List&lt;String&gt; logicNames = new InlineExpressionParser(environment.getProperty(&quot;jdbc.datasource.names&quot;)).splitAndEvaluate();</span><br><span class="line">    for(String logicDsName : logicNames)&#123;</span><br><span class="line">        List&lt;String&gt; realDsNames = new InlineExpressionParser(environment.getProperty(&quot;jdbc.datasource.&quot; + logicDsName.trim()+&quot;.names&quot;)).splitAndEvaluate();</span><br><span class="line">        //加载shardingsphere的sharding配置的数据源</span><br><span class="line">        if(!CollectionUtils.isEmpty(realDsNames))&#123;</span><br><span class="line">            Map&lt;String, DataSource&gt; oneLogicDataSources = new HashMap&lt;&gt;();</span><br><span class="line">            for(String realDsName: realDsNames)&#123;</span><br><span class="line">                DataSource dataSource = DataSourceFactory.createDataSource(new DataSourceConfig(logicDsName,realDsName,</span><br><span class="line">                        DataSourcesEnum.getDataSourcesEnumByName(standardEnv.getProperty(&quot;jdbc.datasource.&quot;+logicDsName+&quot;.&quot;+realDsName+&quot;.pool&quot;)),propertiesReader));</span><br><span class="line">                oneLogicDataSources.put(realDsName,dataSource);</span><br><span class="line">            &#125;</span><br><span class="line">            originalDataSourceMaps.put(logicDsName, oneLogicDataSources);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            // single ds</span><br><span class="line">            /**</span><br><span class="line">            加载如下形式的数据源配置，这种数据源不使用shardingsphere</span><br><span class="line">            jdbc.datasource.tnp_product.url = jdbc:mysql://192.168.120.17:3306/tnp_product?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="line">            jdbc.datasource.tnp_product.username = tnp_dev</span><br><span class="line">            jdbc.datasource.tnp_product.password = tnp_dev</span><br><span class="line">            jdbc.datasource.tnp_product.pool = druid</span><br><span class="line">            jdbc.datasource.tnp_product.driverClass = com.mysql.jdbc.Driver</span><br><span class="line">            **/</span><br><span class="line">            if(environment.containsProperty(&quot;jdbc.datasource.&quot;+logicDsName+&quot;.url&quot;))&#123;</span><br><span class="line">                Map&lt;String, DataSource&gt; oneSingleLogicDataSources = new HashMap&lt;&gt;();</span><br><span class="line">                DataSource dataSource =  DataSourceFactory.createDataSource(new DataSourceConfig(null,logicDsName,</span><br><span class="line">                        DataSourcesEnum.getDataSourcesEnumByName(standardEnv.getProperty(&quot;jdbc.datasource.&quot;+logicDsName+&quot;.pool&quot;)), propertiesReader));</span><br><span class="line">                oneSingleLogicDataSources.put(logicDsName, dataSource);</span><br><span class="line">                originalDataSourceMaps.put(logicDsName, oneSingleLogicDataSources);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置"><a href="#加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置" class="headerlink" title="加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置"></a>加载所有逻辑数据源的shardingsphere配置，包括默认逻辑数据源的配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">private void initPropertiesAndDataSource(Environment environment) &#123;</span><br><span class="line">   //定义分库分片、读写分离、数据脱敏、影子库的Sharding配置</span><br><span class="line">    ShardingRuleConfigurationProperties defaultShardingProperties = new ShardingRuleConfigurationProperties();</span><br><span class="line">    MasterSlaveRuleConfigurationProperties defaultMasterSlaveProperties = new MasterSlaveRuleConfigurationProperties();</span><br><span class="line">    EncryptRuleConfigurationProperties defaultEncryptProperties = new EncryptRuleConfigurationProperties();</span><br><span class="line">    PropertiesConfigurationProperties defaultPropMapProperties = new PropertiesConfigurationProperties();</span><br><span class="line">    ShadowRuleConfigurationProperties defaultShadowProperties = new ShadowRuleConfigurationProperties();</span><br><span class="line">    try &#123;</span><br><span class="line">       //默认配置</span><br><span class="line">        PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.sharding&quot;, defaultShardingProperties, environment);</span><br><span class="line">        PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.masterslave&quot;, defaultMasterSlaveProperties, environment);</span><br><span class="line">        PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.encrypt&quot;, defaultEncryptProperties, environment);</span><br><span class="line">        PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.shadow&quot;, defaultShadowProperties, environment);</span><br><span class="line">        PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere&quot;, defaultPropMapProperties, environment);</span><br><span class="line">        ShardingspherePropertiesConfig defaultShardingspherePropertiesConfig = new ShardingspherePropertiesConfig(defaultShardingProperties,defaultEncryptProperties,defaultMasterSlaveProperties,defaultShadowProperties,defaultPropMapProperties);</span><br><span class="line">        logicDsNameToshardingspherePropertiesConfigs.put(defaultLogicDsName, defaultShardingspherePropertiesConfig);</span><br><span class="line"></span><br><span class="line">        //加载逻辑库的Sharding配置</span><br><span class="line">        List&lt;String&gt; logicNames = new InlineExpressionParser(environment.getProperty(&quot;jdbc.datasource.names&quot;)).splitAndEvaluate();</span><br><span class="line">        for(String logicDsName : logicNames)&#123;</span><br><span class="line">            //datasource have specific sharding configs，比如以cs开头的配置</span><br><span class="line">            if(PropertyUtil.containPropertyPrefix(environment, logicDsName ))&#123;</span><br><span class="line">               // 得到逻辑库名称后边的配置字符串，比如cs.spring.shardingsphere.sharding.props.sql.show = true</span><br><span class="line">               //经过handle会得到spring.shardingsphere.sharding.props.sql.show = true</span><br><span class="line">                Map&lt;String,Object&gt; kvs =  PropertyUtil.handle(environment, logicDsName , Map.class);</span><br><span class="line">                Environment transferEnv = new StandardEnvironment();</span><br><span class="line">                ConfigurableEnvironment configurableEnvironment = (ConfigurableEnvironment)transferEnv;</span><br><span class="line">                MapPropertySource  propertiesPropertySource = new MapPropertySource(&quot;spring.shardingsphere&quot;, kvs);</span><br><span class="line">                configurableEnvironment.getPropertySources().addLast(propertiesPropertySource);</span><br><span class="line"></span><br><span class="line">                ShardingRuleConfigurationProperties shardingProperties = new ShardingRuleConfigurationProperties();</span><br><span class="line">                MasterSlaveRuleConfigurationProperties masterSlaveProperties = new MasterSlaveRuleConfigurationProperties();</span><br><span class="line">                EncryptRuleConfigurationProperties encryptProperties = new EncryptRuleConfigurationProperties();</span><br><span class="line">                PropertiesConfigurationProperties propMapProperties = new PropertiesConfigurationProperties();</span><br><span class="line">                ShadowRuleConfigurationProperties shadowProperties = new ShadowRuleConfigurationProperties();</span><br><span class="line">                PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.sharding&quot;, shardingProperties, transferEnv);</span><br><span class="line">                PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.masterslave&quot;, masterSlaveProperties, transferEnv);</span><br><span class="line">                PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.encrypt&quot;, encryptProperties, transferEnv);</span><br><span class="line">                PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere.shadow&quot;, shadowProperties, transferEnv);</span><br><span class="line">                PropertiesConfigurationUtils.bindPropertiesToTarget(&quot;spring.shardingsphere&quot;, propMapProperties, transferEnv);</span><br><span class="line">                // 每一个逻辑数据库都有可能存在四种可能的shardingsphere的配置，不管有没有，到放到一个ShardingspherePropertiesConfig对象当中</span><br><span class="line">                logicDsNameToshardingspherePropertiesConfigs.put(logicDsName, new ShardingspherePropertiesConfig(shardingProperties,encryptProperties,</span><br><span class="line">                        masterSlaveProperties,shadowProperties,propMapProperties));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new RuntimeException(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是对实体数据源和逻辑数据源的准备工作，实体化了所有的实体数据源，以及加载了逻辑数据源的shardingsphere配置到logicDsNameToshardingspherePropertiesConfigs当中。<br>由于DataSourceConfiger实现了BeanFactoryPostProcessor，因此DataSourceConfiger需要override BeanFactoryPostProcessor的postProcessBeanFactory方法，即在BeanFactory就绪完毕执行的逻辑。</p>
<h3 id="创建Shardingsphere逻辑数据源实例对象，配置事物管理器"><a href="#创建Shardingsphere逻辑数据源实例对象，配置事物管理器" class="headerlink" title="创建Shardingsphere逻辑数据源实例对象，配置事物管理器"></a>创建Shardingsphere逻辑数据源实例对象，配置事物管理器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">    BeanDefinitionRegistry registry = (BeanDefinitionRegistry)beanFactory;</span><br><span class="line">    // key:logicDsName;value:&#123;key:realDsName,value:DataSource&#125;</span><br><span class="line">    for(Map.Entry&lt;String, Map&lt;String, DataSource&gt;&gt; oneLogicDs: originalDataSourceMaps.entrySet())&#123;</span><br><span class="line">        // 在环境配置当中寻找，是否存在一种Shardingsphere配置。</span><br><span class="line">        // 而且一个逻辑数据源只能配置为一种模式（ps:分片策略可以和数据脱敏同时配置，不冲突，参考cs逻辑数据源的配置）</span><br><span class="line">        List&lt;ShardingType&gt; shardingTypes = RuleCondition.getShardingTypes(environment,oneLogicDs.getKey());</span><br><span class="line">        if(1 != shardingTypes.size())&#123;</span><br><span class="line">            throw new Throwable(&quot;only setting one mode in shardingDataSource,masterSlaveDataSource,encryptDataSource,shadowDataSource options&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //sharding逻辑数据源的shardingsphere实例化，根据配置不同，分化为分片、脱敏、读写分离、影子库模式其中一个策略。</span><br><span class="line">        //create and register sharding dataSource</span><br><span class="line">        if(logicDsNameToshardingspherePropertiesConfigs.containsKey(oneLogicDs.getKey()))&#123;</span><br><span class="line">            ShardingsphereDataSourceRegisterFactory.newInstance(shardingTypes.get(0),oneLogicDs.getKey(), oneLogicDs.getValue(),</span><br><span class="line">                    logicDsNameToshardingspherePropertiesConfigs.get(oneLogicDs.getKey()), registry);</span><br><span class="line">        &#125;else if(defaultLogicDsName.equals(oneLogicDs.getKey()))&#123;</span><br><span class="line">            // 默认数据源的shardingsphere实例化</span><br><span class="line">            ShardingsphereDataSourceRegisterFactory.newInstance(shardingTypes.get(0),oneLogicDs.getKey(), oneLogicDs.getValue(),</span><br><span class="line">                    logicDsNameToshardingspherePropertiesConfigs.get(defaultLogicDsName), registry);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //独立数据源的shardingsphere实例化（独立数据源在shardingsphere也是支持的，即没有任何分库分表配置）</span><br><span class="line">            ShardingsphereDataSourceRegisterFactory.newInstance(ShardingType.EMPTY,oneLogicDs.getKey(), oneLogicDs.getValue(),</span><br><span class="line">                    logicDsNameToshardingspherePropertiesConfigs.get(defaultLogicDsName), registry);</span><br><span class="line">        &#125;</span><br><span class="line">        // 为每个shardingsphere逻辑数据源配置事物管理器</span><br><span class="line">        //create and register sharding dataSource`s transactionManager</span><br><span class="line">        String eachTxManagerBeanName = oneLogicDs.getKey()+&quot;TXManager&quot;;</span><br><span class="line">        GenericBeanDefinition eachTxDefinition = new GenericBeanDefinition();</span><br><span class="line">        eachTxDefinition.setBeanClass(DataSourceTransactionManager.class);</span><br><span class="line">        eachTxDefinition.setScope(BeanDefinition.SCOPE_SINGLETON);</span><br><span class="line">        eachTxDefinition.getPropertyValues().addPropertyValue(&quot;dataSource&quot;, new RuntimeBeanReference(oneLogicDs.getKey()));</span><br><span class="line">        eachTxDefinition.addQualifier(new AutowireCandidateQualifier(Qualifier.class, oneLogicDs.getKey()));</span><br><span class="line">        registry.registerBeanDefinition(eachTxManagerBeanName, eachTxDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">    // 事物管理器扫描</span><br><span class="line">    //register sharding transaction scanner</span><br><span class="line">    String shardingTransactionTypeScanner = &quot;shardingTransactionTypeScanner&quot;;</span><br><span class="line">    BeanDefinitionBuilder factory = BeanDefinitionBuilder.rootBeanDefinition(ShardingTransactionTypeScanner.class);</span><br><span class="line">    registry.registerBeanDefinition(shardingTransactionTypeScanner, factory.getBeanDefinition());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>DataSourceConfiger实现了将所有的分库数据源和单库数据源全部同一位shardingsphere的数据源的形式，为后续mybatis的初始化提供了参数。</p>
<h3 id="MybatisConfigure实例化mybatis的配置"><a href="#MybatisConfigure实例化mybatis的配置" class="headerlink" title="MybatisConfigure实例化mybatis的配置"></a>MybatisConfigure实例化mybatis的配置</h3><p>MybatisConfigure实现了 EnvironmentAware, BeanFactoryPostProcessor, ApplicationContextAware三个接口，分别具有了环境配置拉取、bean配置后置处理、以及获取spring上下文的能力。<br>内部有三个成员:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 从environment读取配置</span><br><span class="line">private PropertiesReader propertiesReader;</span><br><span class="line">//spring上下文</span><br><span class="line">private ApplicationContext applicationContext;</span><br><span class="line">//环境元数据</span><br><span class="line">private Environment environment;</span><br></pre></td></tr></table></figure>

<p>成员变量的初始化:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123;</span><br><span class="line">    this.applicationContext = applicationContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void setEnvironment(Environment environment) &#123;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">    this.propertiesReader = new PropertiesReader() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public String getString(String propertyName) &#123;</span><br><span class="line">            return environment.getProperty(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是BeanFactoryPostProcessor接口的能力，借助实现postProcessBeanFactory方法初始化mybatis的配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">    BeanDefinitionRegistry registry = (BeanDefinitionRegistry)beanFactory;</span><br><span class="line">    //把DataSourceConfiger加载完毕的数据源信息拿过来</span><br><span class="line">    //key:logicDsName;value:&#123;key:realDsName,value:DataSource&#125;，即一个逻辑数据源对应多个真实的实体数据源。</span><br><span class="line">    for(Map.Entry&lt;String, Map&lt;String, DataSource&gt;&gt; entity: DataSourceConfiger.originalDataSourceMaps.entrySet())&#123;</span><br><span class="line">        // register  SqlSessionFactoryBean，即构建SqlSessionFactoryBean，SqlSessionFactoryBean封装了mybatis-config.xml的位置、mapper的xml位置信息等</span><br><span class="line">        GenericBeanDefinition definition =  buildSessionFactoryBeanDefinition(entity.getKey());</span><br><span class="line">        //将SqlSessionFactoryBean注册到spring容器</span><br><span class="line">        registry.registerBeanDefinition(entity.getKey() + &quot;sqlSessionFactoryBean&quot;, definition);</span><br><span class="line">        // register  sqlTemplate</span><br><span class="line">        // SqlSessionTemplate是给mapper类使用的，mapper 的java类在访问数据源的时候是通过 SqlSessionTemplate去访问的。</span><br><span class="line">        GenericBeanDefinition eachSqlTemplatedefinition = new GenericBeanDefinition();</span><br><span class="line">        eachSqlTemplatedefinition.setBeanClass(SqlSessionTemplate.class);</span><br><span class="line">        eachSqlTemplatedefinition.setScope(BeanDefinition.SCOPE_SINGLETON);</span><br><span class="line">        eachSqlTemplatedefinition.getConstructorArgumentValues().addIndexedArgumentValue(0, new RuntimeBeanReference(entity.getKey()+&quot;sqlSessionFactoryBean&quot;));</span><br><span class="line">        registry.registerBeanDefinition(entity.getKey()+&quot;sqlTemplate&quot;, eachSqlTemplatedefinition);</span><br><span class="line">    &#125;</span><br><span class="line">    //配置mapper 的java类的扫描（根据mapper上的注解实现扫描的）</span><br><span class="line">    Set&lt;String&gt; basePackages = this.resolveBasePackages();</span><br><span class="line">    MapperScannerConfigurer mapperScannerConfigurer = new MapperScannerConfigurer();</span><br><span class="line">    mapperScannerConfigurer.setApplicationContext(applicationContext);</span><br><span class="line">    mapperScannerConfigurer.setMarkerInterface(Mapper.class);</span><br><span class="line">    //mapper类被注解了@Mapper 会被认为是一个mubatis的mapper</span><br><span class="line">    mapperScannerConfigurer.setAnnotationClass(com.twodragonlake.sharding.jdbc.mapper.annotation.Mapper.class);</span><br><span class="line">    //扫描的根目录</span><br><span class="line">    mapperScannerConfigurer.setBasePackage(com.twodragonlake.sharding.jdbc.common.utils.StringUtils.join(basePackages, &quot;,&quot;));</span><br><span class="line">    //mapper默认使用默认的数据源的sqlTemplate</span><br><span class="line">    mapperScannerConfigurer.setSqlSessionTemplateBeanName(DataSourceConfiger.defaultLogicDsName + &quot;sqlTemplate&quot;);</span><br><span class="line">    //配置为自动扫描生效，mapperScannerConfigurer会根据mapper上的DBSwitch注解，切换为实际的sqlTemplate，稍后讲解mapperScannerConfigurer的逻辑</span><br><span class="line">    int mapperCount = mapperScannerConfigurer.autoConfigure(registry);</span><br><span class="line">    logger.info(&quot;&#123;&#125; mappers have been found and been added to spring container.&quot;, mapperCount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建SqlSessionFactoryBean</span><br><span class="line">//SqlSessionFactoryBean封装了mybatis-config.xml的位置、mapper的xml位置信息等</span><br><span class="line">private GenericBeanDefinition buildSessionFactoryBeanDefinition(String dataBaseName) &#123;</span><br><span class="line">    GenericBeanDefinition definition = new GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(SqlSessionFactoryBean.class);</span><br><span class="line">    definition.setScope(BeanDefinition.SCOPE_SINGLETON);</span><br><span class="line">    definition.getPropertyValues().addPropertyValue(&quot;dataSource&quot;, new RuntimeBeanReference(dataBaseName));</span><br><span class="line">    Resource mybatisResource;</span><br><span class="line">    try &#123;</span><br><span class="line">        Resource[] mybatisResources  = this.applicationContext.getResources(&quot;classpath*:/mybatis-config.xml&quot;);</span><br><span class="line">        mybatisResource = mybatisResources[0];</span><br><span class="line">    &#125; catch (IllegalConfigException e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new IllegalConfigException(&quot;no mybatis-config.xml file exists in classpath.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    definition.getPropertyValues().addPropertyValue(&quot;configLocation&quot;, mybatisResource);</span><br><span class="line"></span><br><span class="line">    String typeAliasesPackage = propertiesReader.getString(&quot;spring.shardingsphere.datasource.typeAliasesPackage&quot;, &quot;&quot;);</span><br><span class="line">    if (!StringUtils.isEmpty(typeAliasesPackage)) &#123;</span><br><span class="line">        definition.getPropertyValues().addPropertyValue(&quot;typeAliasesPackage&quot;, typeAliasesPackage);</span><br><span class="line">    &#125;</span><br><span class="line">    String typeHandlersPackage = propertiesReader.getString(&quot;spring.shardingsphere.datasource.typeHandlersPackage&quot;, &quot;&quot;);</span><br><span class="line">    if (!StringUtils.isEmpty(typeHandlersPackage)) &#123;</span><br><span class="line">        definition.getPropertyValues().addPropertyValue(&quot;typeHandlersPackage&quot;, typeHandlersPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        definition.getPropertyValues().addPropertyValue(&quot;mapperLocations&quot;, this.applicationContext.getResources(&quot;classpath*:/mybatis/**/*.xml&quot;));</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;IOException when loading mapper resource under classpath*:/mybatis/**/*.xml&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取扫描的package根路径</span><br><span class="line">private Set&lt;String&gt; resolveBasePackages() &#123;</span><br><span class="line">    // 获取main方法启动的类(使用异常取巧的编程方式)</span><br><span class="line">    Class&lt;?&gt; main = CommonUtils.findMainClass();</span><br><span class="line">    Set&lt;String&gt; scanPackages = new HashSet&lt;&gt;();</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; scanPackageClasses = new ArrayList&lt;&gt;();</span><br><span class="line">    String basePackages = this.propertiesReader.getString(&quot; &quot;);</span><br><span class="line">    if(StringUtils.isEmpty(basePackages)) &#123;</span><br><span class="line">        //兼容starter，MapperComponentScan 可以配置扫描的路径</span><br><span class="line">        MapperComponentScan mapperComponentScan = main.getAnnotation(MapperComponentScan.class);</span><br><span class="line">        if(mapperComponentScan != null) &#123;</span><br><span class="line">            scanPackages.addAll(Arrays.asList(mapperComponentScan.basePackage()));</span><br><span class="line">            scanPackageClasses.addAll(Arrays.asList(mapperComponentScan.basePackageClasses()));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // MapperScan也可以配置扫描的路径</span><br><span class="line">            MapperScan mapperScan = main.getAnnotation(MapperScan.class);</span><br><span class="line">            if(mapperScan != null) &#123;</span><br><span class="line">                scanPackages.addAll(Arrays.asList(mapperScan.basePackages()));</span><br><span class="line">                scanPackageClasses.addAll(Arrays.asList(mapperScan.basePackageClasses()));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                scanPackageClasses.add(main);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if(scanPackageClasses != null) &#123;</span><br><span class="line">            for(Class&lt;?&gt; packageClass : scanPackageClasses)&#123;</span><br><span class="line">                scanPackages.add(packageClass.getPackage().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        scanPackages.add(basePackages);</span><br><span class="line">    &#125;</span><br><span class="line">    return scanPackages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MapperScannerConfigurer切换mapper的sqlTemplate为实际需要的sqlTemplate"><a href="#MapperScannerConfigurer切换mapper的sqlTemplate为实际需要的sqlTemplate" class="headerlink" title="MapperScannerConfigurer切换mapper的sqlTemplate为实际需要的sqlTemplate"></a>MapperScannerConfigurer切换mapper的sqlTemplate为实际需要的sqlTemplate</h4><p> 这里不对mybatis的一些组件细化讲解，有兴趣可以参考这个课程深化了解mybatis:<br> <img src="https://i.loli.net/2021/07/18/5bMpSuartDmW2L7.png" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">public class MapperScannerConfigurer extends org.mybatis.spring.mapper.MapperScannerConfigurer &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger logger = LoggerFactory.getLogger(MapperScannerConfigurer.class);</span><br><span class="line"></span><br><span class="line">    private MapperHelper mapperHelper = new MapperHelper();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setMarkerInterface(Class&lt;?&gt; superClass) &#123;</span><br><span class="line">        super.setMarkerInterface(superClass);</span><br><span class="line">        if (Marker.class.isAssignableFrom(superClass)) &#123;</span><br><span class="line">            mapperHelper.registerMapper(superClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public MapperHelper getMapperHelper() &#123;</span><br><span class="line">        return mapperHelper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMapperHelper(MapperHelper mapperHelper) &#123;</span><br><span class="line">        this.mapperHelper = mapperHelper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 属性注入</span><br><span class="line">     *</span><br><span class="line">     * @param properties</span><br><span class="line">     */</span><br><span class="line">    public void setProperties(Properties properties) &#123;</span><br><span class="line">        mapperHelper.setProperties(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int autoConfigure( BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        super.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">        //如果没有注册过接口，就注册默认的Mapper接口</span><br><span class="line">        this.mapperHelper.ifEmptyRegisterDefaultInterface();</span><br><span class="line">        String[] names = registry.getBeanDefinitionNames();</span><br><span class="line">        GenericBeanDefinition definition;</span><br><span class="line">        int mapperCount = 0;</span><br><span class="line">        for (String name : names) &#123;</span><br><span class="line">            BeanDefinition beanDefinition = registry.getBeanDefinition(name);</span><br><span class="line">            if (beanDefinition instanceof GenericBeanDefinition) &#123;</span><br><span class="line">                definition = (GenericBeanDefinition) beanDefinition;</span><br><span class="line">                //MapperFactoryBean 是mybatis对mapper在spring当中的抽象，适配了springbean的规范，是一个FactoryBean，FactoryBean其实是一个代理，getObject才是正真的对象</span><br><span class="line">                //这里的意思是如果是一个mybatis的mapper的封装，那么进行一波逻辑操作</span><br><span class="line">                if (StringUtil.isNotEmpty(definition.getBeanClassName()) &amp;&amp; definition.getBeanClassName().equals(&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;)) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        //definition.getPropertyValues().add(&quot;sqlSessionTemplate&quot;, new RuntimeBeanReference(&quot;sqlTemplate&quot;));</span><br><span class="line">                        //得到mapper类的元信息</span><br><span class="line">                        String value = ((ScannedGenericBeanDefinition) definition).getMetadata().getClassName();</span><br><span class="line">                        //得到mapper类对象</span><br><span class="line">                        Class&lt;?&gt; valueClass = Class.forName(value);</span><br><span class="line">                        //尝试得到DBSwitch注解</span><br><span class="line">                        DBSwitch dbSwitch = valueClass.getAnnotation(DBSwitch.class);</span><br><span class="line">                        if(dbSwitch == null || StringUtils.isEmpty(dbSwitch.value()))&#123;</span><br><span class="line">                            // mapper没有配置DBSwitch，则使用默认的sqlTemplate</span><br><span class="line">                            definition.getPropertyValues().add(&quot;sqlSessionTemplate&quot;, new RuntimeBeanReference(DataSourceConfiger.defaultLogicDsName + &quot;sqlTemplate&quot;));</span><br><span class="line">                        &#125;else&#123;</span><br><span class="line">                            //mapper配置了DBSwitch，则使用DBSwitch配置的数据源名称对应的sqlTemplate</span><br><span class="line">                            definition.getPropertyValues().add(&quot;sqlSessionTemplate&quot;, new RuntimeBeanReference(dbSwitch.value()+&quot;sqlTemplate&quot;));</span><br><span class="line">                        &#125;</span><br><span class="line">                        mapperCount++;</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        throw new IllegalStateException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    definition.setBeanClass(tk.mybatis.spring.mapper.MapperFactoryBean.class);</span><br><span class="line">                    definition.getPropertyValues().add(&quot;mapperHelper&quot;, this.mapperHelper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mapperCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>MybatisConfigure 使用DataSourceConfiger里边初始化的数据源，创建了mybatis访问数据源用的SqlSessionTemplate，之后使用SqlSessionTemplate作为参数创建mapper，<br>加载了mapper到spring容器。</p>
<h3 id="使用Encryptor实现定制化脱敏编解码器"><a href="#使用Encryptor实现定制化脱敏编解码器" class="headerlink" title="使用Encryptor实现定制化脱敏编解码器"></a>使用Encryptor实现定制化脱敏编解码器</h3><p>关于shardingsphere的实现方案，参考官方的介绍，<span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2xlZ2FjeS80LngvZG9jdW1lbnQvY24vZmVhdHVyZXMvb3JjaGVzdHJhdGlvbi9lbmNyeXB0Lw==">数据脱敏<i class="fa fa-external-link-alt"></i></span><br>次数不再单独讲解。<br>Encryptor的加载，shardingsphere使用了java的spi机制，首先我们先介绍些 怎么实现一个定制化的Encryptor:</p>
<h4 id="实现Encryptor接口定制一个脱敏编解码器"><a href="#实现Encryptor接口定制一个脱敏编解码器" class="headerlink" title="实现Encryptor接口定制一个脱敏编解码器"></a>实现Encryptor接口定制一个脱敏编解码器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class LLPayAESEncryptor implements Encryptor &#123;</span><br><span class="line">    // Encryptor的配置信息</span><br><span class="line">    private Properties properties = new Properties();</span><br><span class="line">    // IAESCryptService是一个rpc服务，对外提供了信息加密解密的能力</span><br><span class="line">    private static IAESCryptService aESCryptService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        //初始化</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 使用aESCryptService加密</span><br><span class="line">    @Override</span><br><span class="line">    public String encrypt(Object plaintext) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (null != plaintext &amp;&amp; !StringUtils.isEmpty(plaintext)) &#123;</span><br><span class="line">                return aESCryptService.encrypt(plaintext.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (AESException aesException)&#123;</span><br><span class="line">            throw new RuntimeException(aesException);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //使用aESCryptService解密</span><br><span class="line">    @Override</span><br><span class="line">    public Object decrypt(String ciphertext) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (null != ciphertext &amp;&amp; !StringUtils.isEmpty(ciphertext)) &#123;</span><br><span class="line">                return new String (aESCryptService.decrypt(ciphertext),StandardCharsets.UTF_8);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (AESException aesException)&#123;</span><br><span class="line">            throw new RuntimeException(aesException);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 编解码器的类型，EncryptorServiceLoader加载器会根据这个类型字符串加载当前的LLPayAESEncryptor实现</span><br><span class="line">    @Override</span><br><span class="line">    public String getType() &#123;</span><br><span class="line">        return EncryptConstants.LLPAYENCRYPT_AES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Properties getProperties() &#123;</span><br><span class="line">        return properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setProperties(Properties properties) &#123;</span><br><span class="line">        this.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //初始化aESCryptService（如果是dubbo服务，要提前将服务注册到spring容器当中）</span><br><span class="line">    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">        if (null ==  aESCryptService) &#123;</span><br><span class="line">            aESCryptService = beanFactory.getBean(IAESCryptService.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="加载Encryptor"><a href="#加载Encryptor" class="headerlink" title="加载Encryptor"></a>加载Encryptor</h3><p>shardingsphere使用java的spi机制加载脱敏编解码器，shardingsphere有自己封装的loader：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import com.twodragonlake.sharding.jdbc.encrypt.constants.EncryptConstants;</span><br><span class="line">import com.twodragonlake.sharding.jdbc.encrypt.llaes.LLPayAESEncryptor;</span><br><span class="line">import org.apache.shardingsphere.encrypt.strategy.spi.loader.EncryptorServiceLoader;</span><br><span class="line">import org.springframework.beans.BeansException;</span><br><span class="line">import org.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line">import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"></span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">public class EncryptConfigurer implements  BeanFactoryPostProcessor &#123;</span><br><span class="line">    //EncryptorServiceLoaders相当于jdk当中的ServiceLoader，shardingsphere实现了一套适合自己的EncryptorServiceLoader，换汤不换药</span><br><span class="line">    private EncryptorServiceLoader serviceLoader = new EncryptorServiceLoader();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">        // 使用EncryptorServiceLoader加载指定类型的Encryptor</span><br><span class="line">        LLPayAESEncryptor llPayEncryptor = (LLPayAESEncryptor) serviceLoader.newService(EncryptConstants.LLPAYENCRYPT_AES, new Properties());</span><br><span class="line">        //注册到spring容器当中</span><br><span class="line">        llPayEncryptor.postProcessBeanFactory(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="引导"><a href="#引导" class="headerlink" title="引导"></a>引导</h4><p>最后需要配置入口，让EncryptorServiceLoader可以加载到LLPayAESEncryptor，我们把上述EncryptConfigurer和LLPayAESEncryptor可以封装到一个jar当中，业务系统可以直接用maven引入，当业务app启动的时候要想加载LLPayAESEncryptor生效需要遵守java的spi规范，因此需要在我们的jar包当中的resources目录下创建如下结构的文件：<br>-resources<br>  -META-INF.services<br>    org.apache.shardingsphere.encrypt.strategy.spi.Encryptor</p>
<p>org.apache.shardingsphere.encrypt.strategy.spi.Encryptor文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.twodragonlake.sharding.jdbc.encrypt.llaes.LLPayAESEncryptor</span><br></pre></td></tr></table></figure>
<p>即Encryptor的实现LLPayAESEncryptor。</p>
<h4 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h4><p>shardingsphere提供了一套脱敏方案，并且暴露了接口给开发者，可以实现定制化的数据脱敏实现，在我们的例子当中，IAESCryptService的实现可以是阿里云、aws等服务上提供的加密服务，这样就能灵活的配置数据脱敏。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本章主要介绍了 shardin-jdbc在不同的数据库，使用不同的策略的封装和实现，配合mybatis去做了mapper上的兼容，最后介绍了sharding-jdbc脱敏的定制化实现。<br>源码目前还在内部优化，开源之后会放到<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R3b0RyYWdvbkxha2U=">TwoDragonLake<i class="fa fa-external-link-alt"></i></span> Organization当中。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>CeaserWang
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/" title="shardingsphere_jdbc_starter">https://ceaser.wang/2021/07/18/starter_struct/shardingsphere_jdbc_starter/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/shardingsphere/" rel="tag"><i class="fa fa-tag"></i> shardingsphere</a>
              <a href="/tags/jdbc/" rel="tag"><i class="fa fa-tag"></i> jdbc</a>
              <a href="/tags/starter/" rel="tag"><i class="fa fa-tag"></i> starter</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/30/life/leeklife_3/" rel="prev" title="在人间做韭菜的那些年(4)--怎么管理聪明人&送别孤尽">
                  <i class="fa fa-chevron-left"></i> 在人间做韭菜的那些年(4)--怎么管理聪明人&送别孤尽
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/12/31/life/leeklife_4/" rel="next" title="在人间做韭菜的那些年(4)--2021年终总结回顾">
                  在人间做韭菜的那些年(4)--2021年终总结回顾 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CeaserWang</span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"ryAR9bttS7fex1FPEPAylmmJ-gzGzoHsz","app_key":"dYqygoN4Y01Bl38OdRoCHUYn","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
